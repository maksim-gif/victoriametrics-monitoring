#cloud-config
package_update: true
package_upgrade: true

packages:
  - wget
  - curl
  - tar
  - adduser
  - libfontconfig1
  - software-properties-common
  - apt-transport-https
  - gnupg
  - jq

runcmd:
  # Создание пользователя для VictoriaMetrics
  - useradd --no-create-home --shell /bin/false victoriametrics
  
  # Скачивание и установка VictoriaMetrics
  - wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.103.0/victoria-metrics-linux-amd64-v1.103.0.tar.gz -O /tmp/victoria-metrics.tar.gz
  - tar xvf /tmp/victoria-metrics.tar.gz -C /tmp
  - mv /tmp/victoria-metrics-prod /usr/local/bin/victoria-metrics
  - chmod +x /usr/local/bin/victoria-metrics
  - mkdir -p /var/lib/victoria-metrics
  - chown victoriametrics:victoriametrics /var/lib/victoria-metrics
  
  # Создание systemd службы для VictoriaMetrics
  - |
    cat > /etc/systemd/system/victoria-metrics.service << EOF
    [Unit]
    Description=VictoriaMetrics
    After=network.target
    
    [Service]
    Type=simple
    User=victoriametrics
    Group=victoriametrics
    ExecStart=/usr/local/bin/victoria-metrics -storageDataPath=/var/lib/victoria-metrics -httpListenAddr=:8428 -promscrape.config=/etc/victoria-metrics/scrape.yml
    Restart=always
    RestartSec=3
    
    [Install]
    WantedBy=multi-user.target
    EOF
  
  # Создание конфигурации scrape для VictoriaMetrics
  - |
    mkdir -p /etc/victoria-metrics
    cat > /etc/victoria-metrics/scrape.yml << EOF
    global:
      scrape_interval: 15s
      external_labels:
        monitor: 'ubuntu-monitor'
        instance: 'Ubuntu-${var.lastname}'
    
    scrape_configs:
      - job_name: 'node_exporter'
        static_configs:
          - targets: ['localhost:9100']
            labels:
              instance: 'Ubuntu-${var.lastname}'
              group: 'monitoring'
        scrape_interval: 15s
        scrape_timeout: 10s
    EOF
  
  # Скачивание и установка Node Exporter
  - wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz -O /tmp/node_exporter.tar.gz
  - tar xvf /tmp/node_exporter.tar.gz -C /tmp
  - mv /tmp/node_exporter-1.8.2.linux-amd64/node_exporter /usr/local/bin/
  - chmod +x /usr/local/bin/node_exporter
  - useradd --no-create-home --shell /bin/false node_exporter
  
  # Создание systemd службы для Node Exporter
  - |
    cat > /etc/systemd/system/node-exporter.service << EOF
    [Unit]
    Description=Node Exporter
    After=network.target
    
    [Service]
    Type=simple
    User=node_exporter
    Group=node_exporter
    ExecStart=/usr/local/bin/node_exporter
    Restart=always
    RestartSec=3
    
    [Install]
    WantedBy=multi-user.target
    EOF
  
  # Установка Grafana
  - |
    wget -q -O - https://packages.grafana.com/gpg.key | gpg --dearmor | tee /usr/share/keyrings/grafana.gpg > /dev/null
    echo "deb [signed-by=/usr/share/keyrings/grafana.gpg] https://packages.grafana.com/oss/deb stable main" | tee -a /etc/apt/sources.list.d/grafana.list
    apt-get update
    apt-get install -y grafana
  
  # Запуск сервисов
  - systemctl daemon-reload
  - systemctl enable victoria-metrics
  - systemctl start victoria-metrics
  - systemctl enable node-exporter
  - systemctl start node-exporter
  - systemctl enable grafana-server
  - systemctl start grafana-server
  
  # Настройка пароля Grafana и datasource через API
  - |
    sleep 30
    # Ждем запуска Grafana
    for i in {1..30}; do
        if curl -s http://localhost:3000/api/health > /dev/null; then
            break
        fi
        sleep 5
    done
    
    # Изменяем пароль по умолчанию
    curl -X PUT "http://localhost:3000/api/admin/users/1/password" \
      -H "Content-Type: application/json" \
      -u admin:admin \
      --data '{"password":"admin123"}'
    
    # Создаем datasource VictoriaMetrics
    curl -X POST "http://localhost:3000/api/datasources" \
      -H "Content-Type: application/json" \
      -u admin:admin123 \
      --data '{
        "name":"VictoriaMetrics",
        "type":"prometheus",
        "url":"http://localhost:8428",
        "access":"proxy",
        "isDefault":true,
        "jsonData": {
          "timeInterval": "15s"
        }
      }'
    
    # Импортируем Node Exporter dashboard
    curl -X POST "http://localhost:3000/api/dashboards/import" \
      -H "Content-Type: application/json" \
      -u admin:admin123 \
      --data '{
        "dashboard": {
          "id": null,
          "title": "Node Exporter Full - ${var.lastname}",
          "tags": [ "templated" ],
          "timezone": "browser",
          "panels": [],
          "schemaVersion": 16,
          "version": 0
        },
        "overwrite": true
      }' || echo "Dashboard import completed"

  # Создание проверочного скрипта
  - |
    cat > /home/ubuntu/check-services.sh << 'EOF'
    #!/bin/bash
    echo "=== Service Status ==="
    sudo systemctl status victoria-metrics --no-pager -l
    echo ""
    sudo systemctl status node-exporter --no-pager -l
    echo ""
    sudo systemctl status grafana-server --no-pager -l
    
    echo "=== Network Ports ==="
    netstat -tlnp | grep -E ':(8428|9100|3000)'
    
    echo "=== VictoriaMetrics Targets ==="
    curl -s http://localhost:8428/api/v1/targets | jq '.data.activeTargets[] | {job: .scrapePool, instance: .scrapeUrl, health: .health}'
    
    echo "=== Basic Metrics Check ==="
    curl -s http://localhost:8428/api/v1/query?query=up
    echo ""
    EOF
    
    chmod +x /home/ubuntu/check-services.sh

final_message: "=== Deployment Complete ===\nVM: Ubuntu-${var.lastname}\nVictoriaMetrics: http://localhost:8428\nNode Exporter: http://localhost:9100\nGrafana: http://localhost:3000 (admin/admin123)\nCheck script: /home/ubuntu/check-services.sh"
